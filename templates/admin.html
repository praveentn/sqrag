<!-- templates/admin.html -->
{% extends "base.html" %}

{% block title %}Admin Panel - RAG Data Platform{% endblock %}

{% block page_title %}Admin Control Panel{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-outline-primary" onclick="refreshAllData()">
        <i class="fas fa-refresh me-2"></i>Refresh All
    </button>
    <button class="btn btn-outline-warning" onclick="showMaintenanceModal()">
        <i class="fas fa-tools me-2"></i>Maintenance
    </button>
    <button class="btn btn-outline-info" onclick="showBackupModal()">
        <i class="fas fa-download me-2"></i>Backup
    </button>
</div>
{% endblock %}

{% block content %}
<!-- System Health Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2 text-success"></i>
                    System Health Dashboard
                </h5>
                <span class="status-badge status-success" id="overallSystemHealth">All Systems Operational</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-success" id="systemUptime">99.9%</div>
                            <div class="metric-label">Uptime</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-info" id="activeConnections">12</div>
                            <div class="metric-label">Active Connections</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-warning" id="memoryUsage">45%</div>
                            <div class="metric-label">Memory Usage</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-primary" id="diskUsage">23%</div>
                            <div class="metric-label">Disk Usage</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Database Browser -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-database me-2"></i>
                    Database Browser
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshDatabaseBrowser()">
                    <i class="fas fa-refresh"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select class="form-select form-select-sm" id="tableSelector" onchange="loadTableData()">
                        <option value="">Select a table...</option>
                    </select>
                </div>
                <div id="tableDataContainer" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted">
                        Select a table to view its data
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SQL Workbench -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-terminal me-2"></i>
                    SQL Workbench
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="executeSQL()">
                        <i class="fas fa-play me-1"></i>Execute
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSQL()">
                        <i class="fas fa-eraser me-1"></i>Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <textarea id="sqlEditor" class="form-control sql-editor border-0" rows="8" 
                         placeholder="-- Enter your SQL query here
SELECT * FROM customers LIMIT 10;"></textarea>
                <div id="sqlResults" class="border-top" style="max-height: 200px; overflow-y: auto; display: none;">
                    <!-- SQL results will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Query Performance -->
    <div class="col-md-8 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Query Performance Monitoring
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="loadPerformanceData('1h')">1H</button>
                    <button class="btn btn-outline-primary" onclick="loadPerformanceData('24h')">24H</button>
                    <button class="btn btn-outline-primary" onclick="loadPerformanceData('7d')">7D</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- System Metrics -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    System Metrics
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="systemMetrics">
                    <div class="list-group-item d-flex justify-content-between">
                        <span>CPU Usage</span>
                        <span class="fw-bold text-warning">23%</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span class="fw-bold text-info">45%</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Disk I/O</span>
                        <span class="fw-bold text-success">Low</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Network I/O</span>
                        <span class="fw-bold text-primary">Normal</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>LLM API Latency</span>
                        <span class="fw-bold text-success">235ms</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Queue Length</span>
                        <span class="fw-bold text-info">3</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Recent Activity Logs -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    System Logs
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="filterLogs('all')">All</button>
                    <button class="btn btn-outline-info" onclick="filterLogs('info')">Info</button>
                    <button class="btn btn-outline-warning" onclick="filterLogs('warning')">Warning</button>
                    <button class="btn btn-outline-danger" onclick="filterLogs('error')">Error</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="systemLogs" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                    <!-- Logs will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Settings -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configuration
                </h6>
                <button class="btn btn-sm btn-outline-warning" onclick="showConfigModal()">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
            </div>
            <div class="card-body">
                <div id="configurationDisplay">
                    <div class="row">
                        <div class="col-6">
                            <strong>LLM Provider:</strong><br>
                            <span class="text-muted" id="llmProvider">Azure OpenAI</span>
                        </div>
                        <div class="col-6">
                            <strong>Default Model:</strong><br>
                            <span class="text-muted" id="defaultModel">gpt-4</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Max Query Time:</strong><br>
                            <span class="text-muted" id="maxQueryTime">30s</span>
                        </div>
                        <div class="col-6">
                            <strong>Max Result Rows:</strong><br>
                            <span class="text-muted" id="maxRows">10,000</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Embedding Model:</strong><br>
                            <span class="text-muted" id="embeddingModel">all-MiniLM-L6-v2</span>
                        </div>
                        <div class="col-6">
                            <strong>Similarity Threshold:</strong><br>
                            <span class="text-muted" id="similarityThreshold">0.7</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- User Activity (Placeholder for future auth) -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    User Activity
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center text-muted">
                    <i class="fas fa-user-plus fa-3x mb-3 opacity-50"></i>
                    <p>User management not yet implemented</p>
                    <small>Future feature: Track user sessions, query history, and permissions</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup & Maintenance -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Backup & Maintenance
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="createBackup()">
                        <i class="fas fa-download me-2"></i>Create Full Backup
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="cleanupOldData()">
                        <i class="fas fa-broom me-2"></i>Cleanup Old Data
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="optimizeDatabase()">
                        <i class="fas fa-rocket me-2"></i>Optimize Database
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="rebuildIndexes()">
                        <i class="fas fa-redo me-2"></i>Rebuild All Indexes
                    </button>
                </div>
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        Last backup: <span id="lastBackup">Never</span><br>
                        Last optimization: <span id="lastOptimization">2 days ago</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Changes to configuration require an application restart to take effect.
                </div>
                
                <form id="configForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>LLM Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">Provider</label>
                                <select class="form-select" id="configLlmProvider">
                                    <option value="azure_openai">Azure OpenAI</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="mock">Mock (Development)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" id="configLlmModel" value="gpt-4">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Endpoint</label>
                                <input type="text" class="form-control" id="configLlmEndpoint" 
                                       placeholder="https://your-endpoint.openai.azure.com/">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Query Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">Max Execution Time (seconds)</label>
                                <input type="number" class="form-control" id="configMaxTime" value="30" min="5" max="300">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Result Rows</label>
                                <input type="number" class="form-control" id="configMaxRows" value="10000" min="100" max="100000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Confidence Threshold</label>
                                <input type="number" class="form-control" id="configConfidenceThreshold" 
                                       value="0.5" min="0" max="1" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Embedding Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">Default Model</label>
                                <select class="form-select" id="configEmbeddingModel">
                                    <option value="sentence-transformers/all-MiniLM-L6-v2">all-MiniLM-L6-v2</option>
                                    <option value="sentence-transformers/all-mpnet-base-v2">all-mpnet-base-v2</option>
                                    <option value="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2">Multilingual MiniLM</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Similarity Threshold</label>
                                <input type="number" class="form-control" id="configSimilarityThreshold" 
                                       value="0.7" min="0" max="1" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Security Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">Max Query Length</label>
                                <input type="number" class="form-control" id="configMaxQueryLength" value="1000" min="100" max="10000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rate Limit (per hour)</label>
                                <input type="number" class="form-control" id="configRateLimit" value="100" min="10" max="1000">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="saveConfiguration()">
                    <i class="fas fa-save me-1"></i>Save & Restart Required
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Maintenance Modal -->
<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Maintenance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Select maintenance operations to perform:
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="cleanupLogs" checked>
                    <label class="form-check-label" for="cleanupLogs">
                        Clean up old log files (>30 days)
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="cleanupSessions" checked>
                    <label class="form-check-label" for="cleanupSessions">
                        Remove old chat sessions (>90 days)
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="optimizeDb">
                    <label class="form-check-label" for="optimizeDb">
                        Optimize database tables
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="rebuildEmbeddings">
                    <label class="form-check-label" for="rebuildEmbeddings">
                        Rebuild embedding indexes
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="performMaintenance()">
                    <i class="fas fa-tools me-1"></i>Perform Maintenance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="backupForm">
                    <div class="mb-3">
                        <label class="form-label">Backup Type</label>
                        <select class="form-select" id="backupType">
                            <option value="full">Full Backup (Database + Files)</option>
                            <option value="database">Database Only</option>
                            <option value="files">Files Only (Uploads + Indexes)</option>
                            <option value="config">Configuration Only</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Backup Name</label>
                        <input type="text" class="form-control" id="backupName" 
                               value="backup_" placeholder="backup_YYYYMMDD_HHMMSS">
                        <small class="text-muted">Leave empty for auto-generated name</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="compressBackup" checked>
                            <label class="form-check-label" for="compressBackup">
                                Compress backup file
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createBackupWithOptions()">
                    <i class="fas fa-download me-1"></i>Create Backup
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let performanceChart = null;
let metricsInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeAdminPanel();
    setupPerformanceChart();
    startMetricsMonitoring();
    loadSystemLogs();
    loadDatabaseTables();
});

function initializeAdminPanel() {
    // Load initial data
    refreshAllData();
    loadConfiguration();
}

function setupPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Sample performance data
    const data = {
        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
        datasets: [
            {
                label: 'Query Response Time (ms)',
                data: Array.from({length: 24}, () => Math.floor(Math.random() * 500) + 100),
                borderColor: 'rgb(37, 99, 235)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4
            },
            {
                label: 'LLM API Latency (ms)',
                data: Array.from({length: 24}, () => Math.floor(Math.random() * 1000) + 200),
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }
        ]
    };
    
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Response Time (ms)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

function startMetricsMonitoring() {
    // Update metrics every 30 seconds
    metricsInterval = setInterval(updateSystemMetrics, 30000);
    updateSystemMetrics(); // Initial load
}

function updateSystemMetrics() {
    // Simulate real-time metrics updates
    const metrics = {
        cpuUsage: Math.floor(Math.random() * 60) + 10,
        memoryUsage: Math.floor(Math.random() * 40) + 30,
        diskIO: ['Low', 'Normal', 'High'][Math.floor(Math.random() * 3)],
        networkIO: ['Low', 'Normal', 'High'][Math.floor(Math.random() * 3)],
        llmLatency: Math.floor(Math.random() * 300) + 150,
        queueLength: Math.floor(Math.random() * 10)
    };
    
    // Update system metrics display
    const metricsContainer = document.getElementById('systemMetrics');
    metricsContainer.innerHTML = `
        <div class="list-group-item d-flex justify-content-between">
            <span>CPU Usage</span>
            <span class="fw-bold ${getMetricColor(metrics.cpuUsage, 'percent')}">${metrics.cpuUsage}%</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
            <span>Memory Usage</span>
            <span class="fw-bold ${getMetricColor(metrics.memoryUsage, 'percent')}">${metrics.memoryUsage}%</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
            <span>Disk I/O</span>
            <span class="fw-bold ${getMetricColor(metrics.diskIO, 'level')}">${metrics.diskIO}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
            <span>Network I/O</span>
            <span class="fw-bold ${getMetricColor(metrics.networkIO, 'level')}">${metrics.networkIO}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
            <span>LLM API Latency</span>
            <span class="fw-bold ${getMetricColor(metrics.llmLatency, 'latency')}">${metrics.llmLatency}ms</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
            <span>Queue Length</span>
            <span class="fw-bold ${getMetricColor(metrics.queueLength, 'queue')}">${metrics.queueLength}</span>
        </div>
    `;
    
    // Update top-level metrics
    document.getElementById('memoryUsage').textContent = metrics.memoryUsage + '%';
    document.getElementById('activeConnections').textContent = Math.floor(Math.random() * 20) + 5;
}

function getMetricColor(value, type) {
    switch (type) {
        case 'percent':
            if (value < 50) return 'text-success';
            if (value < 80) return 'text-warning';
            return 'text-danger';
        case 'level':
            if (value === 'Low') return 'text-success';
            if (value === 'Normal') return 'text-info';
            return 'text-warning';
        case 'latency':
            if (value < 300) return 'text-success';
            if (value < 600) return 'text-warning';
            return 'text-danger';
        case 'queue':
            if (value < 5) return 'text-success';
            if (value < 10) return 'text-warning';
            return 'text-danger';
        default:
            return 'text-muted';
    }
}

function loadSystemLogs() {
    const logsContainer = document.getElementById('systemLogs');
    
    // Sample log entries
    const logs = [
        { timestamp: new Date(), level: 'info', message: 'New chat session started', category: 'chat' },
        { timestamp: new Date(Date.now() - 60000), level: 'info', message: 'SQL query executed successfully', category: 'query' },
        { timestamp: new Date(Date.now() - 120000), level: 'warning', message: 'LLM API response time elevated', category: 'llm' },
        { timestamp: new Date(Date.now() - 180000), level: 'info', message: 'Dictionary entry added', category: 'dictionary' },
        { timestamp: new Date(Date.now() - 240000), level: 'error', message: 'Failed to connect to external database', category: 'database' },
        { timestamp: new Date(Date.now() - 300000), level: 'info', message: 'Embedding index build completed', category: 'embedding' }
    ];
    
    logsContainer.innerHTML = logs.map(log => `
        <div class="p-2 border-bottom log-entry" data-level="${log.level}">
            <span class="text-muted">${log.timestamp.toLocaleTimeString()}</span>
            <span class="badge ${getLevelBadgeClass(log.level)} mx-2">${log.level.toUpperCase()}</span>
            <span class="${getLevelTextClass(log.level)}">[${log.category}]</span>
            ${log.message}
        </div>
    `).join('');
}

function getLevelBadgeClass(level) {
    const classes = {
        'info': 'bg-info',
        'warning': 'bg-warning',
        'error': 'bg-danger',
        'debug': 'bg-secondary'
    };
    return classes[level] || 'bg-secondary';
}

function getLevelTextClass(level) {
    const classes = {
        'info': 'text-info',
        'warning': 'text-warning',
        'error': 'text-danger',
        'debug': 'text-muted'
    };
    return classes[level] || 'text-muted';
}

function filterLogs(level) {
    const logEntries = document.querySelectorAll('.log-entry');
    
    logEntries.forEach(entry => {
        if (level === 'all' || entry.getAttribute('data-level') === level) {
            entry.style.display = 'block';
        } else {
            entry.style.display = 'none';
        }
    });
    
    // Update button states
    document.querySelectorAll('#systemLogs').forEach(container => {
        container.parentElement.querySelectorAll('.btn-group-sm .btn').forEach(btn => {
            btn.classList.remove('active');
        });
    });
    event.target.classList.add('active');
}

async function loadDatabaseTables() {
    try {
        showToast('Loading database tables...', 'info');
        
        // Fetch all data sources and their tables
        const sources = await apiRequest('/api/data-sources');
        
        const selector = document.getElementById('tableSelector');
        selector.innerHTML = '<option value="">Select a table...</option>';
        
        let totalTables = 0;
        
        sources.forEach(source => {
            if (source.tables && source.tables.length > 0) {
                // Add optgroup for each data source
                const optgroup = document.createElement('optgroup');
                optgroup.label = `${source.name} (${source.type})`;
                
                source.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = `${source.id}:${table.name}`;
                    option.textContent = table.display_name || table.name;
                    option.setAttribute('data-source-id', source.id);
                    option.setAttribute('data-table-name', table.name);
                    option.setAttribute('data-row-count', table.row_count || 0);
                    optgroup.appendChild(option);
                    totalTables++;
                });
                
                selector.appendChild(optgroup);
            }
        });
        
        if (totalTables === 0) {
            selector.innerHTML = '<option value="">No tables found - upload some data first</option>';
            showToast('No tables found. Please upload data sources first.', 'warning');
        } else {
            showToast(`Loaded ${totalTables} tables from ${sources.length} data sources`, 'success');
        }
        
    } catch (error) {
        console.error('Error loading database tables:', error);
        const selector = document.getElementById('tableSelector');
        selector.innerHTML = '<option value="">Error loading tables</option>';
        showToast('Error loading database tables: ' + error.message, 'danger');
    }
}

async function loadTableData() {
    const selector = document.getElementById('tableSelector');
    const selectedValue = selector.value;
    const container = document.getElementById('tableDataContainer');
    
    if (!selectedValue) {
        container.innerHTML = '<div class="text-center text-muted">Select a table to view its data</div>';
        return;
    }
    
    const [sourceId, tableName] = selectedValue.split(':');
    const selectedOption = selector.options[selector.selectedIndex];
    const rowCount = selectedOption.getAttribute('data-row-count') || 0;
    
    container.innerHTML = '<div class="text-center"><div class="loading-spinner me-2"></div>Loading table data...</div>';
    
    try {
        // Call the table data API
        const response = await apiRequest(`/api/data-sources/${sourceId}/tables/${tableName}/data?limit=100`);
        
        if (response.data && response.data.length > 0) {
            const columns = Object.keys(response.data[0]);
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr>${columns.map(col => `<th class="text-nowrap">${col}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${response.data.map(row => 
                                `<tr>${columns.map(col => {
                                    const value = row[col];
                                    const displayValue = value === null ? '<em class="text-muted">NULL</em>' : 
                                                       value === '' ? '<em class="text-muted">Empty</em>' :
                                                       String(value).length > 50 ? String(value).substring(0, 50) + '...' :
                                                       String(value);
                                    return `<td>${displayValue}</td>`;
                                }).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        Showing ${response.data.length} of ${rowCount} rows from <strong>${tableName}</strong>
                        ${response.data.length >= 100 ? ' (limited to first 100 rows)' : ''}
                    </small>
                </div>
            `;
            container.innerHTML = tableHtml;
        } else {
            container.innerHTML = '<div class="text-center text-muted">No data found in this table</div>';
        }
        
    } catch (error) {
        console.error('Error loading table data:', error);
        container.innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading table data: ${error.message}
            </div>
        `;
        showToast('Error loading table data: ' + error.message, 'danger');
    }
}

async function executeSQL() {
    const sqlText = document.getElementById('sqlEditor').value.trim();
    const resultsContainer = document.getElementById('sqlResults');
    
    if (!sqlText) {
        showToast('Please enter a SQL query', 'warning');
        return;
    }
    
    resultsContainer.style.display = 'block';
    resultsContainer.innerHTML = '<div class="p-3 text-center"><div class="loading-spinner me-2"></div>Executing query...</div>';
    
    try {
        const response = await apiRequest('/api/sql/execute', {
            method: 'POST',
            body: JSON.stringify({
                sql: sqlText,
                source_id: null  // Use default source or let user select
            })
        });
        
        if (response.status === 'success') {
            if (response.data && response.data.length > 0) {
                const columns = Object.keys(response.data[0]);
                const tableHtml = `
                    <div class="alert alert-success mb-2">
                        <small><strong>Success:</strong> Query executed in ${response.execution_time?.toFixed(3) || 0}s, returned ${response.row_count || response.data.length} rows</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${response.data.slice(0, 50).map(row => 
                                    `<tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${response.data.length > 50 ? '<small class="text-muted">Showing first 50 rows</small>' : ''}
                `;
                resultsContainer.innerHTML = tableHtml;
            } else {
                resultsContainer.innerHTML = '<div class="alert alert-info">Query executed successfully but returned no data</div>';
            }
            showToast('Query executed successfully', 'success');
        } else {
            resultsContainer.innerHTML = `<div class="alert alert-danger">Error: ${response.error || 'Unknown error'}</div>`;
            showToast('Query execution failed', 'danger');
        }
        
    } catch (error) {
        console.error('Error executing SQL:', error);
        resultsContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        showToast('Error executing SQL: ' + error.message, 'danger');
    }
}

function clearSQL() {
    document.getElementById('sqlEditor').value = '';
    const resultsContainer = document.getElementById('sqlResults');
    resultsContainer.style.display = 'none';
}

function loadConfiguration() {
    // Load current configuration values
    document.getElementById('llmProvider').textContent = 'Azure OpenAI';
    document.getElementById('defaultModel').textContent = 'gpt-4';
    document.getElementById('maxQueryTime').textContent = '30s';
    document.getElementById('maxRows').textContent = '10,000';
    document.getElementById('embeddingModel').textContent = 'all-MiniLM-L6-v2';
    document.getElementById('similarityThreshold').textContent = '0.7';
}

function showConfigModal() {
    const modal = new bootstrap.Modal(document.getElementById('configModal'));
    modal.show();
}

function saveConfiguration() {
    try {
        // This would normally save configuration via API
        showToast('Configuration saved. Restart required to take effect.', 'warning');
        bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
        loadConfiguration();
    } catch (error) {
        console.error('Error saving configuration:', error);
        showToast('Error saving configuration: ' + error.message, 'danger');
    }
}

function showMaintenanceModal() {
    const modal = new bootstrap.Modal(document.getElementById('maintenanceModal'));
    modal.show();
}

async function performMaintenance() {
    try {
        const operations = [];
        if (document.getElementById('cleanupLogs').checked) operations.push('cleanup_logs');
        if (document.getElementById('cleanupSessions').checked) operations.push('cleanup_sessions');
        if (document.getElementById('optimizeDb').checked) operations.push('optimize_db');
        if (document.getElementById('rebuildEmbeddings').checked) operations.push('rebuild_embeddings');
        
        if (operations.length === 0) {
            showToast('Please select at least one maintenance operation', 'warning');
            return;
        }
        
        showToast('Maintenance operations started...', 'info');
        bootstrap.Modal.getInstance(document.getElementById('maintenanceModal')).hide();
        
        // Simulate maintenance operations
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showToast(`Completed ${operations.length} maintenance operations`, 'success');
        
    } catch (error) {
        console.error('Error performing maintenance:', error);
        showToast('Error performing maintenance: ' + error.message, 'danger');
    }
}

function showBackupModal() {
    // Set default backup name
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, '-').substring(0, 19);
    document.getElementById('backupName').value = `backup_${timestamp}`;
    
    const modal = new bootstrap.Modal(document.getElementById('backupModal'));
    modal.show();
}

async function createBackup() {
    try {
        showToast('Creating system backup...', 'info');
        
        // Simulate backup creation
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        showToast('Backup created successfully', 'success');
        
        // Update last backup time
        document.getElementById('lastBackup').textContent = new Date().toLocaleString();
        
    } catch (error) {
        console.error('Error creating backup:', error);
        showToast('Error creating backup: ' + error.message, 'danger');
    }
}

async function createBackupWithOptions() {
    try {
        const backupType = document.getElementById('backupType').value;
        const backupName = document.getElementById('backupName').value || 'auto_backup';
        const compress = document.getElementById('compressBackup').checked;
        
        showToast(`Creating ${backupType} backup...`, 'info');
        bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
        
        // Simulate backup with options
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showToast(`${backupType} backup created: ${backupName}`, 'success');
        
    } catch (error) {
        console.error('Error creating backup:', error);
        showToast('Error creating backup: ' + error.message, 'danger');
    }
}

async function cleanupOldData() {
    if (confirm('This will remove old logs, sessions, and temporary files. Continue?')) {
        try {
            showToast('Cleaning up old data...', 'info');
            await new Promise(resolve => setTimeout(resolve, 2000));
            showToast('Cleanup completed successfully', 'success');
        } catch (error) {
            showToast('Error during cleanup: ' + error.message, 'danger');
        }
    }
}

async function optimizeDatabase() {
    if (confirm('This will optimize database tables and may take some time. Continue?')) {
        try {
            showToast('Optimizing database...', 'info');
            await new Promise(resolve => setTimeout(resolve, 4000));
            showToast('Database optimization completed', 'success');
            document.getElementById('lastOptimization').textContent = new Date().toLocaleString();
        } catch (error) {
            showToast('Error optimizing database: ' + error.message, 'danger');
        }
    }
}

async function rebuildIndexes() {
    if (confirm('This will rebuild all embedding indexes and may take considerable time. Continue?')) {
        try {
            showToast('Rebuilding all indexes...', 'info');
            await new Promise(resolve => setTimeout(resolve, 6000));
            showToast('All indexes rebuilt successfully', 'success');
        } catch (error) {
            showToast('Error rebuilding indexes: ' + error.message, 'danger');
        }
    }
}

function loadPerformanceData(period) {
    // Update chart based on selected period
    if (performanceChart) {
        // This would normally fetch data from API based on period
        performanceChart.update();
    }
    
    // Update button states
    event.target.parentElement.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

async function refreshDatabaseBrowser() {
    showToast('Refreshing database browser...', 'info');
    await loadDatabaseTables();
    
    // Clear table data
    const container = document.getElementById('tableDataContainer');
    container.innerHTML = '<div class="text-center text-muted">Select a table to view its data</div>';
}

function refreshAllData() {
    updateSystemMetrics();
    loadSystemLogs();
    loadDatabaseTables();
    if (performanceChart) {
        performanceChart.update();
    }
}

// Cleanup when page unloads
window.addEventListener('beforeunload', function() {
    if (metricsInterval) {
        clearInterval(metricsInterval);
    }
});
</script>
{% endblock %}