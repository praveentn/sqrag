<!-- templates/chat.html -->
{% extends "base.html" %}

{% block title %}Chat Workspace - RAG Data Platform{% endblock %}

{% block page_title %}Chat Workspace{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary" onclick="newChatSession()">
        <i class="fas fa-plus me-2"></i>New Chat
    </button>
    <button class="btn btn-outline-secondary" onclick="loadChatSessions()">
        <i class="fas fa-history me-2"></i>History
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Chat Sessions Sidebar -->
    <div class="col-md-3 pe-0">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Chat Sessions</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="loadChatSessions()">
                    <i class="fas fa-refresh"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div id="chatSessionsList" style="max-height: 600px; overflow-y: auto;">
                    <div class="text-center text-muted p-3">
                        <div class="loading-spinner me-2"></div>
                        Loading sessions...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9 ps-2">
        <div class="card h-100">
            <!-- Chat Header -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0" id="chatTitle">Select a chat or start a new one</h6>
                    <small class="text-muted" id="chatSubtitle"></small>
                </div>
                <div id="chatActions" style="display: none;">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportChat()">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearChat()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="card-body p-0 d-flex flex-column">
                <div id="chatMessages" class="chat-container flex-grow-1" style="height: 500px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                        <h5>Welcome to RAG Chat</h5>
                        <p>Ask questions about your data in natural language.</p>
                        <div class="mt-4">
                            <h6>Example queries:</h6>
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="setExampleQuery('Show me the top 10 customers by revenue')">
                                    Top customers by revenue
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setExampleQuery('How many orders were placed last month?')">
                                    Orders last month
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setExampleQuery('What are the most popular products?')">
                                    Popular products
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query Input Area -->
                <div class="border-top p-3">
                    <div class="row">
                        <div class="col">
                            <div class="input-group">
                                <textarea id="queryInput" class="form-control" rows="2" 
                                         placeholder="Ask a question about your data..." 
                                         onkeydown="handleQueryKeydown(event)"></textarea>
                                <button class="btn btn-primary" onclick="sendQuery()" id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Press Enter to send, Shift+Enter for new line
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SQL Results Modal -->
<div class="modal fade" id="sqlResultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Query Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- SQL Query Display -->
                <div class="mb-3">
                    <h6>Generated SQL:</h6>
                    <pre class="code-block"><code id="modalSqlCode" class="language-sql"></code></pre>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copySqlToClipboard()">
                        <i class="fas fa-copy me-1"></i>Copy SQL
                    </button>
                </div>

                <!-- Results Table -->
                <div class="mb-3">
                    <h6>Results:</h6>
                    <div id="modalResultsTable" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <!-- Table will be populated dynamically -->
                    </div>
                </div>

                <!-- Query Statistics -->
                <div class="row">
                    <div class="col-md-6">
                        <h6>Statistics:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Execution Time:</strong> <span id="modalExecutionTime">-</span></li>
                            <li><strong>Rows Returned:</strong> <span id="modalRowCount">-</span></li>
                            <li><strong>Confidence:</strong> <span id="modalConfidence">-</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Tables Used:</h6>
                        <div id="modalTablesUsed">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="downloadResults()">
                    <i class="fas fa-download me-1"></i>Download CSV
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Provide Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <div class="mb-3">
                        <label class="form-label">How can we improve this result?</label>
                        <textarea class="form-control" id="feedbackText" rows="4" 
                                 placeholder="e.g., 'Show only data from 2024', 'Include customer names', 'Order by date descending'"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issue Type (optional)</label>
                        <select class="form-select" id="feedbackType">
                            <option value="">Select issue type...</option>
                            <option value="wrong_table">Wrong table selected</option>
                            <option value="missing_filter">Missing filter/condition</option>
                            <option value="wrong_columns">Wrong columns shown</option>
                            <option value="incorrect_aggregation">Incorrect aggregation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let currentMessageId = null;
let isProcessing = false;
let currentStep = null;
let currentContext = {};
let pendingContinue = false;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize session if needed
    if (!currentSessionId) {
        loadChatSessions();
    }
});

async function loadChatSessions() {
    try {
        const sessions = await apiRequest('/api/chat/sessions');
        const container = document.getElementById('chatSessionsList');
        
        if (sessions.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted p-3">
                    <p>No chat sessions yet</p>
                    <button class="btn btn-primary" onclick="newChatSession()">Start Your First Chat</button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = sessions.map(session => `
            <div class="chat-session-item border-bottom p-3 cursor-pointer ${currentSessionId === session.id ? 'active' : ''}" 
                 onclick="loadChatSession(${session.id})">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${session.title}</h6>
                        <small class="text-muted">${new Date(session.created_at).toLocaleDateString()}</small>
                    </div>
                    <div class="dropdown" onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="renameSession(${session.id})">Rename</a></li>
                            <li><a class="dropdown-item" href="#" onclick="deleteSession(${session.id})">Delete</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add click styles
        const style = document.createElement('style');
        style.textContent = `
            .chat-session-item:hover {
                background-color: #f8f9fa;
                cursor: pointer;
            }
            .chat-session-item.active {
                background-color: #e3f2fd;
                border-left: 4px solid var(--primary-color);
            }
        `;
        if (!document.getElementById('chat-session-styles')) {
            style.id = 'chat-session-styles';
            document.head.appendChild(style);
        }
        
    } catch (error) {
        console.error('Error loading chat sessions:', error);
        showToast('Error loading chat sessions', 'danger');
    }
}

async function newChatSession() {
    try {
        const session = await apiRequest('/api/chat/sessions', {
            method: 'POST',
            body: JSON.stringify({ title: 'New Chat' })
        });
        
        currentSessionId = session.id;
        
        // Update UI
        document.getElementById('chatTitle').textContent = 'New Chat';
        document.getElementById('chatSubtitle').textContent = 'Started just now';
        document.getElementById('chatActions').style.display = 'block';
        document.getElementById('chatMessages').innerHTML = getWelcomeMessage();
        
        // Reload sessions list
        await loadChatSessions();
        
        // Focus on input
        document.getElementById('queryInput').focus();
        
    } catch (error) {
        console.error('Error creating new chat session:', error);
        showToast('Error creating new chat session', 'danger');
    }
}

async function loadChatSession(sessionId) {
    try {
        currentSessionId = sessionId;
        
        // Highlight selected session
        document.querySelectorAll('.chat-session-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.closest('.chat-session-item').classList.add('active');
        
        // Load session details
        const session = await apiRequest(`/api/chat/sessions/${sessionId}`);
        
        // Load session messages
        const messages = await apiRequest(`/api/chat/sessions/${sessionId}/messages`);
        
        // Update chat header
        document.getElementById('chatTitle').textContent = session.title || 'Chat Session';
        document.getElementById('chatSubtitle').textContent = `Created ${new Date(session.created_at).toLocaleString()}`;
        document.getElementById('chatActions').style.display = 'block';
        
        // Display messages
        displayMessages(messages);
        
    } catch (error) {
        console.error('Error loading chat session:', error);
        showToast('Error loading chat session', 'danger');
    }
}

function displayMessages(messages) {
    const container = document.getElementById('chatMessages');
    
    if (messages.length === 0) {
        container.innerHTML = getWelcomeMessage();
        return;
    }
    
    container.innerHTML = messages.map(message => formatMessage(message)).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function formatMessage(message) {
    const isUser = message.role === 'user';
    const metadata = message.metadata || {};
    
    let messageHtml = `
        <div class="message ${message.role}">
            <div class="message-content">
                ${formatMessageContent(message.content)}
            </div>
            <div class="message-meta mt-2">
                <small class="text-muted">${new Date(message.created_at).toLocaleTimeString()}</small>
    `;
    
    // Add action buttons for assistant messages with SQL
    if (!isUser && metadata.sql && metadata.execution_result) {
        messageHtml += `
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary me-2" onclick="showSqlResults(${message.id})" 
                        data-sql="${encodeURIComponent(metadata.sql)}" 
                        data-result="${encodeURIComponent(JSON.stringify(metadata.execution_result))}"
                        data-confidence="${metadata.confidence || 0}">
                    <i class="fas fa-table me-1"></i>View Results
                </button>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="showFeedbackModal(${message.id})">
                    <i class="fas fa-comment me-1"></i>Feedback
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="copySql('${encodeURIComponent(metadata.sql)}')">
                    <i class="fas fa-copy me-1"></i>Copy SQL
                </button>
            </div>
        `;
    }
    
    messageHtml += `
            </div>
        </div>
    `;
    
    return messageHtml;
}

function formatMessageContent(content) {
    // Convert markdown-style formatting to HTML
    let formatted = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```sql\n([\s\S]*?)\n```/g, '<pre class="code-block mt-2"><code class="language-sql">$1</code></pre>')
        .replace(/```\n([\s\S]*?)\n```/g, '<pre class="code-block mt-2"><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>')
        .replace(/\n/g, '<br>');
    
    return formatted;
}

function getWelcomeMessage() {
    return `
        <div class="text-center text-muted">
            <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
            <h5>Welcome to RAG Chat</h5>
            <p>Ask questions about your data in natural language.</p>
            <div class="mt-4">
                <h6>Example queries:</h6>
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="setExampleQuery('Show me the top 10 customers by revenue')">
                        Top customers by revenue
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setExampleQuery('How many orders were placed last month?')">
                        Orders last month
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setExampleQuery('What are the most popular products?')">
                        Popular products
                    </button>
                </div>
            </div>
        </div>
    `;
}

function setExampleQuery(query) {
    document.getElementById('queryInput').value = query;
    document.getElementById('queryInput').focus();
}

function handleQueryKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendQuery();
    }
}

async function sendQuery() {
    const input = document.getElementById('queryInput');
    const query = input.value.trim();
    
    if (!query) return;
    
    // Clear previous continue UI
    removeContinueUI();
    
    input.value = '';
    addMessageToUI('user', query);
    
    // Show loading message
    addMessageToUI('assistant', 'ðŸ” Analyzing your query...', null, false);
    
    try {
        const response = await apiRequest('/api/chat/query', {
            method: 'POST',
            body: JSON.stringify({
                query: query,
                session_id: currentSessionId,
                step: 'extract_entities',  // Start with entity extraction
                context: { original_query: query }
            })
        });
        
        // Remove loading message
        const messages = document.querySelectorAll('.message.assistant');
        const lastMessage = messages[messages.length - 1];
        if (lastMessage && lastMessage.textContent.includes('Analyzing')) {
            lastMessage.remove();
        }
        
        handleQueryResponse(response);
        
    } catch (error) {
        console.error('Error sending query:', error);
        
        // Remove loading message
        const messages = document.querySelectorAll('.message.assistant');
        const lastMessage = messages[messages.length - 1];
        if (lastMessage && lastMessage.textContent.includes('Analyzing')) {
            lastMessage.remove();
        }
        
        addMessageToUI('assistant', `Error: ${error.message}`, null, true);
        showToast('Error sending query: ' + error.message, 'danger');
    }
}

function handleQueryResponse(response) {
    currentSessionId = response.session_id;
    
    // Add the assistant response
    const metadata = {
        sql: response.sql,
        execution_result: response.execution_result,
        confidence: response.confidence,
        message_id: response.message_id
    };
    
    addMessageToUI('assistant', response.response, metadata);
    
    // Check if we need to show continue button
    if (response.next_step) {
        currentContext = {
            ...currentContext,
            entities: response.entities,
            matched_terms: response.matched_terms,
            candidate_tables: response.candidate_tables,
            sql: response.sql,
            confidence: response.confidence,
            rationale: response.rationale,
            tables_used: response.tables_used,
            correlation_id: response.correlation_id,
            source_id: response.candidate_tables && response.candidate_tables.length > 0 ? 
                       response.candidate_tables[0].source_id : null
        };
        
        addContinueUI(response.step, currentContext);
    }
}

function addMessageToUI(role, content, metadata = null, isError = false) {
    const container = document.getElementById('chatMessages');
    
    // Remove welcome message if present
    if (container.innerHTML.includes('Welcome to RAG Chat')) {
        container.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    if (isError) {
        messageContent.className += ' text-danger';
    }
    messageContent.innerHTML = formatMessageContent(content);
    
    const messageMeta = document.createElement('div');
    messageMeta.className = 'message-meta mt-2';
    messageMeta.innerHTML = `<small class="text-muted">${new Date().toLocaleTimeString()}</small>`;
    
    // Add action buttons for assistant messages with SQL
    if (role === 'assistant' && metadata && metadata.sql) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'mt-2';
        actionsDiv.innerHTML = `
            <button class="btn btn-sm btn-outline-primary me-2" 
                    onclick="showSqlResultsFromMetadata(this)" 
                    data-sql="${encodeURIComponent(metadata.sql)}" 
                    data-result="${encodeURIComponent(JSON.stringify(metadata.execution_result || {}))}"
                    data-confidence="${metadata.confidence || 0}">
                <i class="fas fa-table me-1"></i>View Results
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="showFeedbackModal(${metadata.message_id || currentMessageId})">
                <i class="fas fa-comment me-1"></i>Feedback
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="copySql('${encodeURIComponent(metadata.sql)}')">
                <i class="fas fa-copy me-1"></i>Copy SQL
            </button>
        `;
        
        messageMeta.appendChild(actionsDiv);
    }
    
    messageDiv.appendChild(messageContent);
    messageDiv.appendChild(messageMeta);
    container.appendChild(messageDiv);
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function showSqlResultsFromMetadata(button) {
    try {
        const sql = decodeURIComponent(button.getAttribute('data-sql'));
        const result = JSON.parse(decodeURIComponent(button.getAttribute('data-result')));
        const confidence = parseFloat(button.getAttribute('data-confidence') || 0);
        
        populateSqlResultsModal(sql, result, { confidence });
        const modal = new bootstrap.Modal(document.getElementById('sqlResultsModal'));
        modal.show();
    } catch (error) {
        console.error('Error showing SQL results:', error);
        showToast('Error displaying SQL results', 'danger');
    }
}

function copySql(encodedSql) {
    try {
        const sql = decodeURIComponent(encodedSql);
        navigator.clipboard.writeText(sql);
        showToast('SQL copied to clipboard', 'success');
    } catch (error) {
        console.error('Error copying SQL:', error);
        showToast('Error copying SQL to clipboard', 'danger');
    }
}

async function showSqlResults(messageId) {
    try {
        showToast('Loading SQL results...', 'info');
        // This would fetch message details from API if needed
    } catch (error) {
        console.error('Error showing SQL results:', error);
        showToast('Error loading SQL results', 'danger');
    }
}

function populateSqlResultsModal(sql, executionResult, metadata = {}) {
    document.getElementById('modalSqlCode').textContent = sql;
    
    // Populate statistics
    document.getElementById('modalExecutionTime').textContent = 
        executionResult.execution_time ? `${executionResult.execution_time}s` : 'N/A';
    document.getElementById('modalRowCount').textContent = 
        executionResult.row_count || 0;
    document.getElementById('modalConfidence').textContent = 
        metadata.confidence ? `${Math.round(metadata.confidence * 100)}%` : 'N/A';
    
    // Populate tables used
    const tablesUsed = metadata.candidate_tables || [];
    document.getElementById('modalTablesUsed').innerHTML = 
        tablesUsed.length > 0 ? tablesUsed.join(', ') : 'N/A';
    
    // Populate results table
    const resultsContainer = document.getElementById('modalResultsTable');
    if (executionResult.data && executionResult.data.length > 0) {
        const data = executionResult.data;
        const columns = executionResult.columns || Object.keys(data[0]);
        
        let tableHtml = `
            <table class="table table-striped table-hover">
                <thead>
                    <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                </thead>
                <tbody>
                    ${data.map(row => 
                        `<tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
                    ).join('')}
                </tbody>
            </table>
        `;
        
        if (executionResult.row_count > data.length) {
            tableHtml += `<div class="text-muted text-center mt-2">
                Showing ${data.length} of ${executionResult.row_count} rows
            </div>`;
        }
        
        resultsContainer.innerHTML = tableHtml;
    } else {
        resultsContainer.innerHTML = '<div class="text-muted">No results to display</div>';
    }
    
    // Highlight SQL code
    if (window.Prism) {
        Prism.highlightElement(document.getElementById('modalSqlCode'));
    }
}

function copySqlToClipboard() {
    const sqlCode = document.getElementById('modalSqlCode').textContent;
    navigator.clipboard.writeText(sqlCode);
    showToast('SQL copied to clipboard', 'success');
}

function showFeedbackModal(messageId = null) {
    currentMessageId = messageId || currentMessageId;
    document.getElementById('feedbackForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    modal.show();
}

async function submitFeedback() {
    try {
        const feedbackText = document.getElementById('feedbackText').value.trim();
        if (!feedbackText) {
            showToast('Please provide feedback text', 'warning');
            return;
        }
        
        const response = await apiRequest('/api/chat/feedback', {
            method: 'POST',
            body: JSON.stringify({
                feedback: feedbackText,
                session_id: currentSessionId,
                message_id: currentMessageId
            })
        });
        
        // Add refined response to UI
        addMessageToUI('assistant', response.response, response);
        
        // Close modal and clear form
        bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
        document.getElementById('feedbackForm').reset();
        
        showToast('Feedback processed successfully', 'success');
        
    } catch (error) {
        console.error('Error submitting feedback:', error);
        showToast('Error processing feedback', 'danger');
    }
}

async function exportChat() {
    if (!currentSessionId) return;
    
    try {
        showToast('Export feature not fully implemented', 'info');
    } catch (error) {
        console.error('Error exporting chat:', error);
        showToast('Error exporting chat', 'danger');
    }
}

async function clearChat() {
    if (!currentSessionId) return;
    
    if (confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
        try {
            await deleteSession(currentSessionId);
        } catch (error) {
            console.error('Error deleting chat:', error);
            showToast('Error deleting chat', 'danger');
        }
    }
}

async function deleteSession(sessionId) {
    try {
        await apiRequest(`/api/chat/sessions/${sessionId}`, {
            method: 'DELETE'
        });
        
        // Reset UI if this was the current session
        if (currentSessionId === sessionId) {
            currentSessionId = null;
            currentMessageId = null;
            document.getElementById('chatTitle').textContent = 'Select a chat or start a new one';
            document.getElementById('chatSubtitle').textContent = '';
            document.getElementById('chatActions').style.display = 'none';
            document.getElementById('chatMessages').innerHTML = getWelcomeMessage();
        }
        
        // Reload sessions
        await loadChatSessions();
        
        showToast('Chat deleted successfully', 'success');
        
    } catch (error) {
        console.error('Error deleting session:', error);
        showToast('Error deleting chat session', 'danger');
        throw error;
    }
}

async function renameSession(sessionId) {
    const newTitle = prompt('Enter new title for this chat:');
    if (newTitle && newTitle.trim()) {
        try {
            await apiRequest(`/api/chat/sessions/${sessionId}`, {
                method: 'PUT',
                body: JSON.stringify({ title: newTitle.trim() })
            });
            
            await loadChatSessions();
            
            if (currentSessionId === sessionId) {
                document.getElementById('chatTitle').textContent = newTitle.trim();
            }
            
            showToast('Chat renamed successfully', 'success');
        } catch (error) {
            console.error('Error renaming session:', error);
            showToast('Error renaming chat session', 'danger');
        }
    }
}

function downloadResults() {
    // This would download the current results as CSV
    showToast('Download feature not fully implemented', 'info');
}


function addContinueUI(step, context) {
    currentStep = step;
    currentContext = context;
    pendingContinue = true;
    
    // Add continue button after the last message
    const container = document.getElementById('chatMessages');
    const existingContinue = document.getElementById('continueButtonContainer');
    if (existingContinue) {
        existingContinue.remove();
    }
    
    if (step === 'extract_entities') {
        const continueDiv = document.createElement('div');
        continueDiv.id = 'continueButtonContainer';
        continueDiv.className = 'text-center mt-3 mb-3';
        continueDiv.innerHTML = `
            <div class="card border-primary">
                <div class="card-body py-2">
                    <button class="btn btn-primary me-2" onclick="continueToNextStep()">
                        <i class="fas fa-arrow-right me-2"></i>Continue to SQL Generation
                    </button>
                    <button class="btn btn-outline-secondary" onclick="modifyEntities()">
                        <i class="fas fa-edit me-2"></i>Modify Entities
                    </button>
                </div>
            </div>
        `;
        container.appendChild(continueDiv);
    } else if (step === 'generate_sql') {
        const continueDiv = document.createElement('div');
        continueDiv.id = 'continueButtonContainer';
        continueDiv.className = 'text-center mt-3 mb-3';
        continueDiv.innerHTML = `
            <div class="card border-success">
                <div class="card-body py-2">
                    <button class="btn btn-success me-2" onclick="continueToNextStep()">
                        <i class="fas fa-play me-2"></i>Execute SQL
                    </button>
                    <button class="btn btn-outline-warning me-2" onclick="modifySQL()">
                        <i class="fas fa-edit me-2"></i>Modify SQL
                    </button>
                    <button class="btn btn-outline-secondary" onclick="startOver()">
                        <i class="fas fa-redo me-2"></i>Start Over
                    </button>
                </div>
            </div>
        `;
        container.appendChild(continueDiv);
    }
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function removeContinueUI() {
    const existingContinue = document.getElementById('continueButtonContainer');
    if (existingContinue) {
        existingContinue.remove();
    }
    pendingContinue = false;
}

async function continueToNextStep() {
    if (!currentStep || !pendingContinue) return;
    
    try {
        removeContinueUI();
        
        let nextStep;
        if (currentStep === 'extract_entities') {
            nextStep = 'generate_sql';
            addMessageToUI('user', 'Continue to SQL generation', null, false);
        } else if (currentStep === 'generate_sql') {
            nextStep = 'execute_sql';
            addMessageToUI('user', 'Execute the SQL query', null, false);
        }
        
        addMessageToUI('assistant', 'ðŸ”„ Processing...', null, false);
        
        const response = await apiRequest('/api/chat/query', {
            method: 'POST',
            body: JSON.stringify({
                query: currentContext.original_query || 'Continue',
                session_id: currentSessionId,
                step: nextStep,
                context: currentContext
            })
        });
        
        // Remove processing message
        const messages = document.querySelectorAll('.message.assistant');
        const lastMessage = messages[messages.length - 1];
        if (lastMessage && lastMessage.textContent.includes('Processing...')) {
            lastMessage.remove();
        }
        
        handleQueryResponse(response);
        
    } catch (error) {
        console.error('Error continuing to next step:', error);
        showToast('Error continuing to next step: ' + error.message, 'danger');
        removeContinueUI();
    }
}

function modifyEntities() {
    // Implement entity modification functionality
    showToast('Entity modification feature coming soon', 'info');
}

function modifySQL() {
    // Implement SQL modification functionality  
    showToast('SQL modification feature coming soon', 'info');
}

function startOver() {
    removeContinueUI();
    currentStep = null;
    currentContext = {};
    const queryInput = document.getElementById('queryInput');
    queryInput.value = '';
    queryInput.focus();
}




</script>
{% endblock %}