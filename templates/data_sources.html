<!-- templates/data_sources.html -->
{% extends "base.html" %}

{% block title %}Data Sources - RAG Data Platform{% endblock %}

{% block page_title %}Data Source Manager{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary" onclick="showAddDataSourceModal()">
        <i class="fas fa-plus me-2"></i>Add Data Source
    </button>
    <button class="btn btn-outline-secondary" onclick="refreshDataSources()">
        <i class="fas fa-refresh me-2"></i>Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Overview Cards -->
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="metric-value" id="totalSources">-</div>
            <div class="metric-label">Total Sources</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="metric-value" id="totalTables">-</div>
            <div class="metric-label">Total Tables</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="metric-value" id="totalRows">-</div>
            <div class="metric-label">Total Rows</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="metric-value" id="totalColumns">-</div>
            <div class="metric-label">Total Columns</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>
                    Data Sources
                </h5>
                <div class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm" id="searchInput" 
                           placeholder="Search sources..." style="width: 200px;" 
                           onkeyup="filterDataSources()">
                    <select class="form-select form-select-sm" id="typeFilter" 
                            onchange="filterDataSources()" style="width: auto;">
                        <option value="">All Types</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                        <option value="postgresql">PostgreSQL</option>
                        <option value="mysql">MySQL</option>
                        <option value="sqlite">SQLite</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="dataSourcesContainer">
                    <div class="text-center p-4">
                        <div class="loading-spinner me-2"></div>
                        Loading data sources...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Data Source Modal -->
<div class="modal fade" id="dataSourceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataSourceModalTitle">Add Data Source</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dataSourceForm" enctype="multipart/form-data">
                    <input type="hidden" id="editSourceId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Source Type *</label>
                                <select class="form-select" id="sourceType" required onchange="toggleConnectionFields()">
                                    <option value="">Select type...</option>
                                    <option value="csv">CSV File</option>
                                    <option value="excel">Excel File</option>
                                    <option value="postgresql">PostgreSQL</option>
                                    <option value="mysql">MySQL</option>
                                    <option value="sqlite">SQLite</option>
                                    <option value="mssql">SQL Server</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="sourceName" required>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div id="fileUploadSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">File</label>
                            <input type="file" class="form-control" id="sourceFile" name="file" accept=".csv,.xlsx,.xls">
                        </div>
                    </div>

                    <!-- Database Connection Section -->
                    <div id="connectionSection" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Host</label>
                                    <input type="text" class="form-control" id="dbHost" placeholder="localhost">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Port</label>
                                    <input type="number" class="form-control" id="dbPort" placeholder="5432">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Database</label>
                                    <input type="text" class="form-control" id="dbName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="dbUsername">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="dbPassword">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Connection String (advanced)</label>
                            <textarea class="form-control" id="connectionString" rows="2" 
                                    placeholder="Leave empty to auto-generate from fields above"></textarea>
                            <small class="text-muted">If provided, this will override the individual fields above</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="sourceDescription" rows="2" 
                                placeholder="Optional description of this data source"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="testConnectionBtn" onclick="testConnection()">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDataSource()">
                    <span id="saveButtonText">Add Source</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Source Details Modal -->
<div class="modal fade" id="sourceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sourceDetailsTitle">Source Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h6>Tables</h6>
                        <div id="sourceTablesContainer">
                            <div class="loading-spinner me-2"></div>
                            Loading tables...
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Statistics</h6>
                        <div id="sourceStatsContainer">
                            <div class="loading-spinner me-2"></div>
                            Loading statistics...
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>Sample Data</h6>
                        <div id="sampleDataContainer">
                            <div class="text-center text-muted p-3">
                                Select a table to view sample data
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="refresh_metadata()">
                    <i class="fas fa-refresh me-1"></i>Refresh _metadata
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Table/Column Description Modal -->
<div class="modal fade" id="descriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="descriptionModalTitle">Edit Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="descriptionForm">
                    <input type="hidden" id="descriptionItemId">
                    <input type="hidden" id="descriptionItemType">
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="descriptionText" rows="4" 
                                 placeholder="Enter a business-friendly description..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDescription()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSourceId = null;
let allDataSources = [];

document.addEventListener('DOMContentLoaded', function() {
    loadDataSources();
    setupFileUpload();
});

async function loadDataSources() {
    try {
        const sources = await apiRequest('/api/data-sources');
        allDataSources = sources;
        
        updateOverviewCards(sources);
        displayDataSources(sources);
        
    } catch (error) {
        console.error('Error loading data sources:', error);
        showToast('Error loading data sources', 'danger');
    }
}

function updateOverviewCards(sources) {
    document.getElementById('totalSources').textContent = sources.length;
    
    let totalTables = 0;
    let totalRows = 0;
    let totalColumns = 0;
    
    // These would normally come from the API response
    // For now, we'll use placeholder calculations
    sources.forEach(source => {
        totalTables += Math.floor(Math.random() * 10) + 1; // Placeholder
        totalRows += Math.floor(Math.random() * 100000) + 1000; // Placeholder
        totalColumns += Math.floor(Math.random() * 50) + 5; // Placeholder
    });
    
    document.getElementById('totalTables').textContent = totalTables;
    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
    document.getElementById('totalColumns').textContent = totalColumns;
}

function displayDataSources(sources) {
    const container = document.getElementById('dataSourcesContainer');
    
    if (sources.length === 0) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="fas fa-database fa-4x text-muted mb-3"></i>
                <h5>No Data Sources</h5>
                <p class="text-muted">Get started by adding your first data source</p>
                <button class="btn btn-primary" onclick="showAddDataSourceModal()">
                    <i class="fas fa-plus me-2"></i>Add Data Source
                </button>
            </div>
        `;
        return;
    }
    
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Last Refresh</th>
                        <th>Tables</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sources.map(source => createSourceRow(source)).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHtml;
}

function createSourceRow(source) {
    const typeIcon = getTypeIcon(source.type);
    const statusBadge = getStatusBadge('active'); // Placeholder
    const lastRefresh = source.last_refresh ? 
        new Date(source.last_refresh).toLocaleString() : 'Never';
    
    return `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="${typeIcon} me-2 text-primary"></i>
                    <div>
                        <div class="fw-bold">${source.name}</div>
                        <small class="text-muted">${source.type.toUpperCase()}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-light text-dark">${source.type.toUpperCase()}</span>
            </td>
            <td>${statusBadge}</td>
            <td>
                <small>${lastRefresh}</small>
            </td>
            <td>
                <span class="badge bg-info">${Math.floor(Math.random() * 10) + 1}</span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="showSourceDetails(${source.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="testSourceConnection(${source.id})" title="Test Connection">
                        <i class="fas fa-plug"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="refreshSource_metadata(${source.id})" title="Refresh">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="editDataSource(${source.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteDataSource(${source.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function getTypeIcon(type) {
    const icons = {
        'csv': 'fas fa-file-csv',
        'excel': 'fas fa-file-excel',
        'postgresql': 'fas fa-database',
        'mysql': 'fas fa-database',
        'sqlite': 'fas fa-database',
        'mssql': 'fas fa-database'
    };
    return icons[type] || 'fas fa-database';
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span class="status-badge status-success">Active</span>',
        'error': '<span class="status-badge status-error">Error</span>',
        'connecting': '<span class="status-badge status-warning">Connecting</span>'
    };
    return badges[status] || badges['active'];
}

function filterDataSources() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    
    const filteredSources = allDataSources.filter(source => {
        const matchesSearch = source.name.toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || source.type === typeFilter;
        return matchesSearch && matchesType;
    });
    
    displayDataSources(filteredSources);
}

function setupFileUpload() {
    const uploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('sourceFile');
    
    setupFileUpload(uploadArea, fileInput, handleFileSelect);
}

function handleFileSelect(file) {
    const maxSize = 100 * 1024 * 1024; // 100MB
    
    if (file.size > maxSize) {
        showToast('File size exceeds 100MB limit', 'danger');
        return;
    }
    
    const allowedTypes = ['.csv', '.xlsx', '.xls'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(fileExtension)) {
        showToast('Invalid file type. Please select a CSV or Excel file.', 'danger');
        return;
    }
    
    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatBytes(file.size);
    document.getElementById('fileInfo').style.display = 'block';
}

function clearFile() {
    document.getElementById('sourceFile').value = '';
    document.getElementById('fileInfo').style.display = 'none';
}

function toggleConnectionFields() {
    const sourceType = document.getElementById('sourceType').value;
    const fileSection = document.getElementById('fileUploadSection');
    const connectionSection = document.getElementById('connectionSection');
    const testBtn = document.getElementById('testConnectionBtn');
    
    const isFileType = sourceType === 'csv' || sourceType === 'excel';
    
    fileSection.style.display = isFileType ? 'block' : 'none';
    connectionSection.style.display = isFileType ? 'none' : 'block';
    testBtn.style.display = isFileType ? 'none' : 'inline-block';
    
    // Set default ports
    const defaultPorts = {
        'postgresql': 5432,
        'mysql': 3306,
        'mssql': 1433
    };
    
    if (defaultPorts[sourceType]) {
        document.getElementById('dbPort').value = defaultPorts[sourceType];
    }
}

function showAddDataSourceModal() {
    document.getElementById('dataSourceModalTitle').textContent = 'Add Data Source';
    document.getElementById('saveButtonText').textContent = 'Add Source';
    document.getElementById('dataSourceForm').reset();
    document.getElementById('editSourceId').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    
    toggleConnectionFields();
    
    const modal = new bootstrap.Modal(document.getElementById('dataSourceModal'));
    modal.show();
}

async function testConnection() {
    const sourceType = document.getElementById('sourceType').value;
    if (!sourceType) {
        showToast('Please select a source type first', 'warning');
        return;
    }
    
    const testBtn = document.getElementById('testConnectionBtn');
    showLoading(testBtn);
    
    try {
        // Build connection data
        const connectionData = buildConnectionData();
        
        // Test connection (this would call the actual API)
        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call
        
        showToast('Connection test successful!', 'success');
        
    } catch (error) {
        console.error('Error testing connection:', error);
        showToast('Connection test failed: ' + error.message, 'danger');
    } finally {
        hideLoading(testBtn);
    }
}

function buildConnectionData() {
    const sourceType = document.getElementById('sourceType').value;
    
    if (sourceType === 'csv' || sourceType === 'excel') {
        const file = document.getElementById('sourceFile').files[0];
        if (!file) {
            throw new Error('Please select a file');
        }
        return {
            type: sourceType,
            file: file
        };
    } else {
        const connectionString = document.getElementById('connectionString').value;
        if (connectionString) {
            return {
                type: sourceType,
                connection_string: connectionString
            };
        } else {
            // Build connection string from individual fields
            const host = document.getElementById('dbHost').value;
            const port = document.getElementById('dbPort').value;
            const database = document.getElementById('dbName').value;
            const username = document.getElementById('dbUsername').value;
            const password = document.getElementById('dbPassword').value;
            
            if (!host || !database) {
                throw new Error('Host and database are required');
            }
            
            const connStr = `${sourceType}://${username}:${password}@${host}:${port}/${database}`;
            return {
                type: sourceType,
                connection_string: connStr
            };
        }
    }
}

async function saveDataSource() {
    try {
        const sourceName = document.getElementById('sourceName').value.trim();
        const sourceType = document.getElementById('sourceType').value;
        
        if (!sourceName || !sourceType) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }
        
        const saveBtn = event.target;
        showLoading(saveBtn);
        
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('name', sourceName);
        formData.append('type', sourceType);
        formData.append('description', document.getElementById('sourceDescription').value);
        
        if (sourceType === 'csv' || sourceType === 'excel') {
            const file = document.getElementById('sourceFile').files[0];
            if (!file) {
                showToast('Please select a file', 'warning');
                hideLoading(saveBtn);
                return;
            }
            formData.append('file', file);
        } else {
            const connectionString = document.getElementById('connectionString').value ||
                buildConnectionString();
            formData.append('connection_string', connectionString);
        }
        
        const editId = document.getElementById('editSourceId').value;
        const method = editId ? 'PUT' : 'POST';
        const url = editId ? `/api/data-sources/${editId}` : '/api/data-sources';
        
        const response = await fetch(url, {
            method: method,
            body: formData
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Request failed');
        }
        
        showToast(editId ? 'Data source updated successfully' : 'Data source added successfully', 'success');
        
        // Close modal and refresh list
        bootstrap.Modal.getInstance(document.getElementById('dataSourceModal')).hide();
        loadDataSources();
        
    } catch (error) {
        console.error('Error saving data source:', error);
        showToast('Error saving data source: ' + error.message, 'danger');
    } finally {
        hideLoading(event.target);
    }
}

function buildConnectionString() {
    const sourceType = document.getElementById('sourceType').value;
    const host = document.getElementById('dbHost').value;
    const port = document.getElementById('dbPort').value;
    const database = document.getElementById('dbName').value;
    const username = document.getElementById('dbUsername').value;
    const password = document.getElementById('dbPassword').value;
    
    if (!host || !database) {
        throw new Error('Host and database are required');
    }
    
    return `${sourceType}://${username}:${password}@${host}:${port}/${database}`;
}


async function showSourceDetails(sourceId) {
    currentSourceId = sourceId;
    
    try {
        // Find source in our array
        const source = allDataSources.find(s => s.id === sourceId);
        if (!source) {
            showToast('Source not found', 'danger');
            return;
        }
        
        document.getElementById('sourceDetailsTitle').textContent = `${source.name} - Details`;
        
        // Load source statistics and tables
        loadSourceTables(sourceId);
        loadSourceStats(sourceId);
        
        const modal = new bootstrap.Modal(document.getElementById('sourceDetailsModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error showing source details:', error);
        showToast('Error loading source details', 'danger');
    }
}

async function loadSourceTables(sourceId) {
    try {
        // This would fetch tables from API
        const tablesContainer = document.getElementById('sourceTablesContainer');
        
        // Placeholder data
        const tables = [
            { name: 'customers', row_count: 1250, column_count: 8, description: 'Customer information' },
            { name: 'orders', row_count: 3420, column_count: 12, description: 'Order transactions' },
            { name: 'products', row_count: 156, column_count: 6, description: 'Product catalog' }
        ];
        
        tablesContainer.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Table</th>
                            <th>Rows</th>
                            <th>Columns</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tables.map(table => `
                            <tr>
                                <td>
                                    <div class="fw-bold">${table.name}</div>
                                    <small class="text-muted">${table.description || 'No description'}</small>
                                </td>
                                <td>${table.row_count.toLocaleString()}</td>
                                <td>${table.column_count}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showSampleData('${table.name}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editTableDescription('${table.name}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading source tables:', error);
    }
}

async function loadSourceStats(sourceId) {
    try {
        const statsContainer = document.getElementById('sourceStatsContainer');
        
        // Placeholder stats
        const stats = {
            total_tables: 3,
            total_rows: 4826,
            total_columns: 26,
            last_refresh: new Date().toISOString(),
            file_size: '2.4 MB'
        };
        
        statsContainer.innerHTML = `
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between">
                    <span>Tables</span>
                    <strong>${stats.total_tables}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Total Rows</span>
                    <strong>${stats.total_rows.toLocaleString()}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Total Columns</span>
                    <strong>${stats.total_columns}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>File Size</span>
                    <strong>${stats.file_size}</strong>
                </div>
                <div class="list-group-item">
                    <small class="text-muted">
                        Last refresh: ${new Date(stats.last_refresh).toLocaleString()}
                    </small>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading source stats:', error);
    }
}

async function showSampleData(tableName) {
    try {
        const container = document.getElementById('sampleDataContainer');
        container.innerHTML = '<div class="text-center p-3"><div class="loading-spinner me-2"></div>Loading sample data...</div>';
        
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Placeholder sample data
        const sampleData = [
            { id: 1, name: 'John Doe', email: 'john@example.com', created_at: '2024-01-15' },
            { id: 2, name: 'Jane Smith', email: 'jane@example.com', created_at: '2024-01-16' },
            { id: 3, name: 'Bob Johnson', email: 'bob@example.com', created_at: '2024-01-17' }
        ];
        
        if (sampleData.length > 0) {
            const columns = Object.keys(sampleData[0]);
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${sampleData.map(row => 
                                `<tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-muted text-center mt-2">
                    <small>Showing sample data from ${tableName}</small>
                </div>
            `;
            container.innerHTML = tableHtml;
        } else {
            container.innerHTML = '<div class="text-center text-muted p-3">No sample data available</div>';
        }
        
    } catch (error) {
        console.error('Error loading sample data:', error);
        document.getElementById('sampleDataContainer').innerHTML = 
            '<div class="text-center text-danger p-3">Error loading sample data</div>';
    }
}

async function refreshSource_metadata(sourceId) {
    try {
        showToast('Refreshing _metadata...', 'info');
        
        // Simulate API call
        await apiRequest(`/api/data-sources/${sourceId}/refresh`, {
            method: 'POST'
        });
        
        showToast('_metadata refreshed successfully', 'success');
        
        if (currentSourceId === sourceId) {
            loadSourceTables(sourceId);
            loadSourceStats(sourceId);
        }
        
        loadDataSources();
        
    } catch (error) {
        console.error('Error refreshing _metadata:', error);
        showToast('Error refreshing _metadata: ' + error.message, 'danger');
    }
}

async function deleteDataSource(sourceId) {
    const source = allDataSources.find(s => s.id === sourceId);
    if (!source) return;
    
    if (confirm(`Are you sure you want to delete "${source.name}"? This action cannot be undone.`)) {
        try {
            await apiRequest(`/api/data-sources/${sourceId}`, {
                method: 'DELETE'
            });
            
            showToast('Data source deleted successfully', 'success');
            loadDataSources();
            
        } catch (error) {
            console.error('Error deleting data source:', error);
            showToast('Error deleting data source: ' + error.message, 'danger');
        }
    }
}

function refreshDataSources() {
    loadDataSources();
}

async function testSourceConnection(sourceId) {
    try {
        showToast('Testing connection...', 'info');
        
        const result = await apiRequest(`/api/data-sources/${sourceId}/test`, {
            method: 'POST'
        });
        
        if (result.status === 'success') {
            showToast('Connection test successful', 'success');
        } else {
            showToast('Connection test failed: ' + result.message, 'danger');
        }
        
    } catch (error) {
        console.error('Error testing connection:', error);
        showToast('Connection test failed: ' + error.message, 'danger');
    }
}

function editDataSource(sourceId) {
    // This would populate the modal with existing data for editing
    showToast('Edit functionality not fully implemented', 'info');
}

function editTableDescription(tableName) {
    document.getElementById('descriptionModalTitle').textContent = `Edit Table Description - ${tableName}`;
    document.getElementById('descriptionItemType').value = 'table';
    document.getElementById('descriptionItemId').value = tableName;
    document.getElementById('descriptionText').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('descriptionModal'));
    modal.show();
}

async function saveDescription() {
    try {
        const itemType = document.getElementById('descriptionItemType').value;
        const itemId = document.getElementById('descriptionItemId').value;
        const description = document.getElementById('descriptionText').value;
        
        // This would save the description via API
        showToast('Description saved successfully', 'success');
        
        bootstrap.Modal.getInstance(document.getElementById('descriptionModal')).hide();
        
        // Refresh the current view
        if (currentSourceId) {
            loadSourceTables(currentSourceId);
        }
        
    } catch (error) {
        console.error('Error saving description:', error);
        showToast('Error saving description: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}