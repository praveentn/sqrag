<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}Dashboard - RAG Data Platform{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="refreshDashboard()">
    <i class="fas fa-refresh me-2"></i>Refresh
</button>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- System Overview Cards -->
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="metric-value" id="dataSourcesCount">-</div>
            <div class="metric-label">Data Sources</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="metric-value" id="tablesCount">-</div>
            <div class="metric-label">Tables</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="metric-value" id="dictionaryCount">-</div>
            <div class="metric-label">Dictionary Terms</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="metric-value" id="chatSessionsCount">-</div>
            <div class="metric-label">Chat Sessions</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- System Health -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2 text-success"></i>
                    System Health
                </h5>
                <span class="status-badge status-success" id="overallHealth">Healthy</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Database</span>
                            <span class="status-badge status-success" id="dbHealth">Online</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>LLM Service</span>
                            <span class="status-badge status-success" id="llmHealth">Connected</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Embeddings</span>
                            <span class="status-badge status-success" id="embeddingHealth">Ready</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Query Engine</span>
                            <span class="status-badge status-success" id="queryHealth">Active</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Last checked: <span id="lastHealthCheck">-</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2 text-info"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div id="recentActivity">
                    <div class="text-center text-muted">
                        <div class="loading-spinner me-2"></div>
                        Loading recent activity...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Query Performance -->
    <div class="col-md-8 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2 text-primary"></i>
                    Query Performance (Last 24h)
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadQueryStats('24h')">24h</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadQueryStats('7d')">7d</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadQueryStats('30d')">30d</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="queryPerformanceChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2 text-warning"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('chat') }}" class="btn btn-primary">
                        <i class="fas fa-comments me-2"></i>
                        Start New Chat
                    </a>
                    <button class="btn btn-outline-primary" onclick="showAddDataSourceModal()">
                        <i class="fas fa-plus me-2"></i>
                        Add Data Source
                    </button>
                    <button class="btn btn-outline-secondary" onclick="generateDictionary()">
                        <i class="fas fa-magic me-2"></i>
                        Generate Dictionary
                    </button>
                    <button class="btn btn-outline-info" onclick="createEmbeddingIndex()">
                        <i class="fas fa-vector-square me-2"></i>
                        Build Index
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Data Sources Overview -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2 text-secondary"></i>
                    Data Sources
                </h5>
                <a href="{{ url_for('data_sources') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div id="dataSourcesList">
                    <div class="text-center text-muted">
                        <div class="loading-spinner me-2"></div>
                        Loading data sources...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Embedding Indexes -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-vector-square me-2 text-info"></i>
                    Embedding Indexes
                </h5>
                <a href="{{ url_for('embeddings') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div id="embeddingIndexes">
                    <div class="text-center text-muted">
                        <div class="loading-spinner me-2"></div>
                        Loading indexes...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Data Source Modal -->
<div class="modal fade" id="addDataSourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Data Source</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDataSourceForm">
                    <div class="mb-3">
                        <label class="form-label">Source Type</label>
                        <select class="form-select" id="sourceType" required>
                            <option value="">Select type...</option>
                            <option value="csv">CSV File</option>
                            <option value="excel">Excel File</option>
                            <option value="postgresql">PostgreSQL</option>
                            <option value="mysql">MySQL</option>
                            <option value="sqlite">SQLite</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="sourceName" required>
                    </div>
                    <div id="fileUploadSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">File</label>
                            <input type="file" class="form-control" id="sourceFile" accept=".csv,.xlsx,.xls">
                        </div>
                    </div>
                    <div id="connectionSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Connection String</label>
                            <input type="text" class="form-control" id="connectionString" 
                                   placeholder="e.g., postgresql://user:pass@localhost/db">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitDataSource()">Add Source</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let queryChart = null;

document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    loadQueryPerformanceChart();
    
    // Setup auto-refresh
    setupAutoRefresh(refreshDashboard, 60000); // Refresh every minute
    
    // Setup add data source modal
    setupAddDataSourceModal();
});

async function refreshDashboard() {
    try {
        await Promise.all([
            loadSystemStats(),
            loadSystemHealth(),
            loadRecentActivity(),
            loadDataSources(),
            loadEmbeddingIndexes()
        ]);
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
        showToast('Error refreshing dashboard', 'danger');
    }
}

async function loadSystemStats() {
    try {
        const stats = await apiRequest('/api/admin/stats');
        
        document.getElementById('dataSourcesCount').textContent = stats.data_sources || 0;
        document.getElementById('tablesCount').textContent = stats.tables || 0;
        document.getElementById('dictionaryCount').textContent = stats.dictionary_entries || 0;
        document.getElementById('chatSessionsCount').textContent = stats.chat_sessions || 0;
    } catch (error) {
        console.error('Error loading system stats:', error);
    }
}

async function loadSystemHealth() {
    try {
        const health = await apiRequest('/api/admin/health');
        
        // Update health indicators
        const dbHealth = document.getElementById('dbHealth');
        const llmHealth = document.getElementById('llmHealth');
        const embeddingHealth = document.getElementById('embeddingHealth');
        const queryHealth = document.getElementById('queryHealth');
        const overallHealth = document.getElementById('overallHealth');
        const lastCheck = document.getElementById('lastHealthCheck');
        
        // Set individual service health
        updateHealthBadge(dbHealth, health.database === 'healthy');
        updateHealthBadge(llmHealth, health.llm_service === 'healthy');
        updateHealthBadge(embeddingHealth, health.embedding_service === 'healthy');
        updateHealthBadge(queryHealth, true); // Assume healthy if we can make the request
        
        // Set overall health
        const allHealthy = health.database === 'healthy' && 
                          health.llm_service === 'healthy' && 
                          health.embedding_service === 'healthy';
        updateHealthBadge(overallHealth, allHealthy);
        
        lastCheck.textContent = new Date(health.timestamp).toLocaleTimeString();
    } catch (error) {
        console.error('Error loading system health:', error);
        // Set all to error state
        const badges = ['dbHealth', 'llmHealth', 'embeddingHealth', 'queryHealth', 'overallHealth'];
        badges.forEach(id => updateHealthBadge(document.getElementById(id), false));
    }
}

function updateHealthBadge(element, isHealthy) {
    element.className = `status-badge ${isHealthy ? 'status-success' : 'status-error'}`;
    element.textContent = isHealthy ? (element.id === 'overallHealth' ? 'Healthy' : 'Online') : 
                                    (element.id === 'overallHealth' ? 'Issues' : 'Error');
}

async function loadRecentActivity() {
    try {
        // This would normally fetch recent activity from an API
        // For now, we'll show a placeholder
        const activityContainer = document.getElementById('recentActivity');
        
        const activities = [
            { time: '2 min ago', action: 'New chat session started', icon: 'fas fa-comments', type: 'info' },
            { time: '5 min ago', action: 'SQL query executed successfully', icon: 'fas fa-check-circle', type: 'success' },
            { time: '12 min ago', action: 'Dictionary updated', icon: 'fas fa-book', type: 'primary' },
            { time: '18 min ago', action: 'Data source refreshed', icon: 'fas fa-database', type: 'secondary' }
        ];
        
        activityContainer.innerHTML = activities.map(activity => `
            <div class="d-flex align-items-center mb-2">
                <div class="me-3">
                    <i class="${activity.icon} text-${activity.type}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="small">${activity.action}</div>
                    <div class="text-muted" style="font-size: 0.8rem;">${activity.time}</div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
}

async function loadDataSources() {
    try {
        const sources = await apiRequest('/api/data-sources');
        const container = document.getElementById('dataSourcesList');
        
        if (sources.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No data sources configured</div>';
            return;
        }
        
        container.innerHTML = sources.slice(0, 5).map(source => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div>
                    <div class="fw-bold">${source.name}</div>
                    <small class="text-muted">${source.type.toUpperCase()}</small>
                </div>
                <div>
                    <span class="status-badge status-success">Active</span>
                </div>
            </div>
        `).join('');
        
        if (sources.length > 5) {
            container.innerHTML += `<div class="text-center mt-2">
                <small class="text-muted">and ${sources.length - 5} more...</small>
            </div>`;
        }
    } catch (error) {
        console.error('Error loading data sources:', error);
        document.getElementById('dataSourcesList').innerHTML = 
            '<div class="text-center text-danger">Error loading data sources</div>';
    }
}

async function loadEmbeddingIndexes() {
    try {
        // This would fetch embedding indexes from API
        const container = document.getElementById('embeddingIndexes');
        
        // Placeholder data
        const indexes = [
            { name: 'table_index', status: 'ready', items: 25 },
            { name: 'column_index', status: 'ready', items: 142 },
            { name: 'dictionary_index', status: 'building', items: 89 }
        ];
        
        container.innerHTML = indexes.map(index => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div>
                    <div class="fw-bold">${index.name}</div>
                    <small class="text-muted">${index.items} items</small>
                </div>
                <div>
                    <span class="status-badge ${index.status === 'ready' ? 'status-success' : 'status-warning'}">
                        ${index.status}
                    </span>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading embedding indexes:', error);
    }
}

async function loadQueryPerformanceChart() {
    const ctx = document.getElementById('queryPerformanceChart').getContext('2d');
    
    // Sample data - would normally come from API
    const data = {
        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
        datasets: [{
            label: 'Queries per Hour',
            data: Array.from({length: 24}, () => Math.floor(Math.random() * 20) + 5),
            borderColor: 'rgb(37, 99, 235)',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.4
        }]
    };
    
    queryChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function setupAddDataSourceModal() {
    const sourceType = document.getElementById('sourceType');
    const fileSection = document.getElementById('fileUploadSection');
    const connectionSection = document.getElementById('connectionSection');
    
    sourceType.addEventListener('change', function() {
        const isFile = this.value === 'csv' || this.value === 'excel';
        fileSection.style.display = isFile ? 'block' : 'none';
        connectionSection.style.display = isFile ? 'none' : 'block';
    });
}

function showAddDataSourceModal() {
    const modal = new bootstrap.Modal(document.getElementById('addDataSourceModal'));
    modal.show();
}

async function submitDataSource() {
    try {
        const form = document.getElementById('addDataSourceForm');
        const formData = new FormData(form);
        
        const sourceType = document.getElementById('sourceType').value;
        const sourceName = document.getElementById('sourceName').value;
        
        if (!sourceType || !sourceName) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }
        
        const data = {
            name: sourceName,
            type: sourceType
        };
        
        if (sourceType === 'csv' || sourceType === 'excel') {
            const file = document.getElementById('sourceFile').files[0];
            if (!file) {
                showToast('Please select a file', 'warning');
                return;
            }
            // In a real implementation, you'd upload the file first
            data.file_path = `/uploads/${file.name}`;
        } else {
            const connectionString = document.getElementById('connectionString').value;
            if (!connectionString) {
                showToast('Please provide a connection string', 'warning');
                return;
            }
            data.connection_string = connectionString;
        }
        
        const result = await apiRequest('/api/data-sources', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        
        showToast('Data source added successfully', 'success');
        
        // Close modal and refresh dashboard
        bootstrap.Modal.getInstance(document.getElementById('addDataSourceModal')).hide();
        refreshDashboard();
        
    } catch (error) {
        console.error('Error adding data source:', error);
        showToast('Error adding data source: ' + error.message, 'danger');
    }
}

async function generateDictionary() {
    try {
        showToast('Generating dictionary...', 'info');
        
        const result = await apiRequest('/api/dictionary/generate', {
            method: 'POST'
        });
        
        showToast('Dictionary generated successfully', 'success');
        refreshDashboard();
    } catch (error) {
        console.error('Error generating dictionary:', error);
        showToast('Error generating dictionary: ' + error.message, 'danger');
    }
}

async function createEmbeddingIndex() {
    try {
        showToast('Creating embedding index...', 'info');
        
        const result = await apiRequest('/api/embeddings/create', {
            method: 'POST',
            body: JSON.stringify({
                scope: 'table',
                backend: 'faiss'
            })
        });
        
        showToast('Embedding index creation started', 'success');
        refreshDashboard();
    } catch (error) {
        console.error('Error creating embedding index:', error);
        showToast('Error creating embedding index: ' + error.message, 'danger');
    }
}

function loadQueryStats(period) {
    // Update chart based on selected period
    if (queryChart) {
        // This would normally fetch data from API based on period
        queryChart.update();
    }
}
</script>
{% endblock %}